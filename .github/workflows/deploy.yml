name: Deploy to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -H 89.33.236.171 >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh root@89.33.236.171 << 'EOF'
          set -e

          APP_DB_NAME="${{ secrets.MYSQL_DATABASE }}"
          APP_DB_USER="${{ secrets.MYSQL_USER }}"
          APP_DB_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"
          if [ -z "$APP_DB_NAME" ] || [ -z "$APP_DB_USER" ] || [ -z "$APP_DB_PASSWORD" ]; then
            echo "Missing required GitHub secrets: MYSQL_DATABASE, MYSQL_USER, MYSQL_PASSWORD."
            exit 1
          fi
          APP_CONN="Server=127.0.0.1;Port=3306;Database=$APP_DB_NAME;User=$APP_DB_USER;Password=$APP_DB_PASSWORD;SslMode=None;"

          # Ensure Adminer is served by PHP (not as plain text source)
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get install -y nginx php-fpm php-mysql mariadb-server mariadb-client curl
          systemctl enable --now mariadb

          mysql --user=root --protocol=socket <<SQL
          CREATE DATABASE IF NOT EXISTS \`$APP_DB_NAME\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
          CREATE USER IF NOT EXISTS '$APP_DB_USER'@'localhost' IDENTIFIED BY '$APP_DB_PASSWORD';
          ALTER USER '$APP_DB_USER'@'localhost' IDENTIFIED BY '$APP_DB_PASSWORD';
          GRANT ALL PRIVILEGES ON \`$APP_DB_NAME\`.* TO '$APP_DB_USER'@'localhost';
          FLUSH PRIVILEGES;
          SQL

          mkdir -p /var/www/adminer
          curl -fsSL -o /var/www/adminer/index.php https://github.com/vrana/adminer/releases/download/v5.4.2/adminer-5.4.2.php
          chown -R www-data:www-data /var/www/adminer
          chmod 0755 /var/www/adminer
          chmod 0644 /var/www/adminer/index.php

          PHP_FPM_SOCK="$(find /run/php -maxdepth 1 -name 'php*-fpm.sock' | sort | tail -n1)"
          if [ -z "$PHP_FPM_SOCK" ]; then
            echo "Nu am gasit socket php-fpm in /run/php."
            exit 1
          fi
          PHP_FPM_SERVICE="$(basename "$PHP_FPM_SOCK" .sock)"

          if [ -f /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem ] && [ -f /etc/letsencrypt/live/db.adebisi.ro/privkey.pem ]; then
          cat >/etc/nginx/sites-available/db.adebisi.ro <<NGINX
          server {
              listen 80;
              server_name db.adebisi.ro;
              return 301 https://\$host\$request_uri;
          }

          server {
              listen 443 ssl http2;
              server_name db.adebisi.ro;

              ssl_certificate /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/db.adebisi.ro/privkey.pem;

              root /var/www/adminer;
              index index.php;

              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:$PHP_FPM_SOCK;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          NGINX
          else
          cat >/etc/nginx/sites-available/db.adebisi.ro <<NGINX
          server {
              listen 80;
              server_name db.adebisi.ro;

              root /var/www/adminer;
              index index.php;

              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:$PHP_FPM_SOCK;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          NGINX
            echo "Certificatul pentru db.adebisi.ro nu a fost gasit. Site-ul a ramas pe HTTP."
          fi

          if ss -ltnp | grep -qE ':(80|443)\s.*apache2'; then
            echo "Apache2 is listening on 80/443. Configuring Apache vhost for Adminer with PHP-FPM."
            a2enmod proxy proxy_fcgi setenvif >/dev/null
            if [ -f /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem ] && [ -f /etc/letsencrypt/live/db.adebisi.ro/privkey.pem ]; then
              a2enmod ssl >/dev/null
              cat >/etc/apache2/sites-available/db.adebisi.ro.conf <<APACHE
          <VirtualHost *:80>
              ServerName db.adebisi.ro
              Redirect permanent / https://db.adebisi.ro/
          </VirtualHost>

          <VirtualHost *:443>
              ServerName db.adebisi.ro
              DocumentRoot /var/www/adminer

              SSLEngine on
              SSLCertificateFile /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem
              SSLCertificateKeyFile /etc/letsencrypt/live/db.adebisi.ro/privkey.pem

              <Directory /var/www/adminer>
                  DirectoryIndex index.php
                  AllowOverride None
                  Require all granted
              </Directory>

              <FilesMatch "\.php$">
                  SetHandler "proxy:unix:$PHP_FPM_SOCK|fcgi://localhost/"
              </FilesMatch>
          </VirtualHost>
          APACHE
            else
              cat >/etc/apache2/sites-available/db.adebisi.ro.conf <<APACHE
          <VirtualHost *:80>
              ServerName db.adebisi.ro
              DocumentRoot /var/www/adminer

              <Directory /var/www/adminer>
                  DirectoryIndex index.php
                  AllowOverride None
                  Require all granted
              </Directory>

              <FilesMatch "\.php$">
                  SetHandler "proxy:unix:$PHP_FPM_SOCK|fcgi://localhost/"
              </FilesMatch>
          </VirtualHost>
          APACHE
            fi

            a2dissite db.adebisi.ro-le-ssl.conf >/dev/null 2>&1 || true
            a2ensite db.adebisi.ro.conf >/dev/null
            apache2ctl configtest
            systemctl restart "$PHP_FPM_SERVICE"
            if ! systemctl reload apache2; then
              systemctl restart apache2
            fi
            systemctl status apache2 --no-pager -l || true
            ss -ltnp | grep -E ':(80|443)\s' || true
          else
            ln -sf /etc/nginx/sites-available/db.adebisi.ro /etc/nginx/sites-enabled/db.adebisi.ro
            nginx -t
            systemctl restart "$PHP_FPM_SERVICE"
            if ! systemctl reload nginx; then
              echo "Nginx reload failed, trying full restart..."
              if ! systemctl restart nginx; then
                echo "Nginx failed to start. Diagnostics:"
                systemctl status nginx --no-pager -l || true
                journalctl -xeu nginx.service --no-pager | tail -n 120 || true
                ss -ltnp | grep -E ':(80|443)\s' || true
                exit 1
              fi
            fi
          fi

          cd /var/www/datesantiere
          git pull
          dotnet publish -c Release -o /var/www/datesantiere/publish

          mkdir -p /etc/systemd/system/datesantiere.service.d
          cat >/etc/systemd/system/datesantiere.service.d/override.conf <<SYSTEMD
          [Service]
          Environment="ConnectionStrings__DefaultConnection=$APP_CONN"
          SYSTEMD
          systemctl daemon-reload

          cd /var/www/datesantiere/DateSantiere.Web
          ConnectionStrings__DefaultConnection="$APP_CONN" dotnet ef database update
          systemctl restart datesantiere
          echo "MySQL configured for app: host=127.0.0.1 db=$APP_DB_NAME user=$APP_DB_USER"
          EOF


