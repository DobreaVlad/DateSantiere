name: Deploy to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -H 89.33.236.171 >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        run: |
          # Pass secrets to the remote safely (avoid any bash interpretation of special chars).
          APP_DB_PASSWORD_B64="$(printf '%s' "$MYSQL_PASSWORD" | base64 -w0)"
          ssh root@89.33.236.171 "APP_DB_NAME=$(printf %q "$MYSQL_DATABASE") APP_DB_USER=$(printf %q "$MYSQL_USER") APP_DB_PASSWORD_B64=$(printf %q "$APP_DB_PASSWORD_B64") bash -s" << 'EOF'
          set -e

          if [ -z "${APP_DB_NAME:-}" ] || [ -z "${APP_DB_USER:-}" ] || [ -z "${APP_DB_PASSWORD_B64:-}" ]; then
            echo "Missing required GitHub secrets: MYSQL_DATABASE, MYSQL_USER, MYSQL_PASSWORD."
            exit 1
          fi
          APP_DB_PASSWORD="$(printf '%s' "$APP_DB_PASSWORD_B64" | base64 -d)"
          APP_CONN="Server=127.0.0.1;Port=3306;Database=$APP_DB_NAME;User=$APP_DB_USER;Password=$APP_DB_PASSWORD;SslMode=None;"

          # Ensure Adminer is served by PHP (not as plain text source)
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get install -y nginx php-fpm php-mysql mariadb-server mariadb-client curl
          systemctl enable --now mariadb

          # SQL-escape any single quotes in the password.
          APP_DB_PASSWORD_SQL="$(printf "%s" "$APP_DB_PASSWORD" | sed "s/'/''/g")"
          DB_SQL="CREATE DATABASE IF NOT EXISTS \\`$APP_DB_NAME\\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; CREATE USER IF NOT EXISTS '$APP_DB_USER'@'localhost' IDENTIFIED BY '$APP_DB_PASSWORD_SQL'; ALTER USER '$APP_DB_USER'@'localhost' IDENTIFIED BY '$APP_DB_PASSWORD_SQL'; GRANT ALL PRIVILEGES ON \\`$APP_DB_NAME\\`.* TO '$APP_DB_USER'@'localhost'; FLUSH PRIVILEGES;"

          run_db_sql() {
            # 1) Prefer root via local unix socket (no password) if available.
            if mysql --no-defaults --user=root --protocol=socket --socket=/run/mysqld/mysqld.sock -e "SELECT 1" >/dev/null 2>&1; then
              mysql --no-defaults --user=root --protocol=socket --socket=/run/mysqld/mysqld.sock -e "$DB_SQL"
              return 0
            fi

            # 2) Fallback to debian-sys-maint credentials if present.
            if [ -f /etc/mysql/debian.cnf ]; then
              if mysql --no-defaults --defaults-extra-file=/etc/mysql/debian.cnf -e "SELECT 1" >/dev/null 2>&1; then
                mysql --no-defaults --defaults-extra-file=/etc/mysql/debian.cnf -e "$DB_SQL"
                return 0
              fi
            fi

            return 1
          }

          if ! run_db_sql; then
            echo "MariaDB admin auth failed (root socket + debian.cnf). Attempting emergency local reset to unix_socket..."
            systemctl stop mariadb

            # Start a local-only server that ignores grants; used to re-enable unix_socket for root.
            nohup mysqld_safe --skip-grant-tables --skip-networking >/tmp/mysqld_safe.log 2>&1 &
            for i in $(seq 1 30); do
              [ -S /run/mysqld/mysqld.sock ] && break
              sleep 1
            done
            if [ ! -S /run/mysqld/mysqld.sock ]; then
              echo "mysqld_safe did not start (no socket)."
              tail -n 200 /tmp/mysqld_safe.log || true
              exit 1
            fi

            mysql --no-defaults --protocol=socket --socket=/run/mysqld/mysqld.sock -e "FLUSH PRIVILEGES; ALTER USER 'root'@'localhost' IDENTIFIED VIA unix_socket; FLUSH PRIVILEGES;"

            mysqladmin --no-defaults --protocol=socket --socket=/run/mysqld/mysqld.sock shutdown >/dev/null 2>&1 || true
            systemctl start mariadb

            if ! run_db_sql; then
              echo "MariaDB provisioning still failing after emergency reset."
              exit 1
            fi
          fi

          mkdir -p /var/www/adminer
          curl -fsSL -o /var/www/adminer/index.php https://github.com/vrana/adminer/releases/download/v5.4.2/adminer-5.4.2.php
          chown -R www-data:www-data /var/www/adminer
          chmod 0755 /var/www/adminer
          chmod 0644 /var/www/adminer/index.php

          PHP_FPM_SOCK="$(find /run/php -maxdepth 1 -name 'php*-fpm.sock' | sort | tail -n1)"
          if [ -z "$PHP_FPM_SOCK" ]; then
            echo "Nu am gasit socket php-fpm in /run/php."
            exit 1
          fi
          PHP_FPM_SERVICE="$(basename "$PHP_FPM_SOCK" .sock)"

          if [ -f /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem ] && [ -f /etc/letsencrypt/live/db.adebisi.ro/privkey.pem ]; then
          cat >/etc/nginx/sites-available/db.adebisi.ro <<NGINX
          server {
              listen 80;
              server_name db.adebisi.ro;
              return 301 https://\$host\$request_uri;
          }

          server {
              listen 443 ssl http2;
              server_name db.adebisi.ro;

              ssl_certificate /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/db.adebisi.ro/privkey.pem;

              root /var/www/adminer;
              index index.php;

              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:$PHP_FPM_SOCK;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          NGINX
          else
          cat >/etc/nginx/sites-available/db.adebisi.ro <<NGINX
          server {
              listen 80;
              server_name db.adebisi.ro;

              root /var/www/adminer;
              index index.php;

              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:$PHP_FPM_SOCK;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          NGINX
            echo "Certificatul pentru db.adebisi.ro nu a fost gasit. Site-ul a ramas pe HTTP."
          fi

          if ss -ltnp | grep -qE ':(80|443)\s.*apache2'; then
            echo "Apache2 is listening on 80/443. Configuring Apache vhost for Adminer with PHP-FPM."
            a2enmod proxy proxy_fcgi setenvif >/dev/null
            if [ -f /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem ] && [ -f /etc/letsencrypt/live/db.adebisi.ro/privkey.pem ]; then
              a2enmod ssl >/dev/null
              cat >/etc/apache2/sites-available/db.adebisi.ro.conf <<APACHE
          <VirtualHost *:80>
              ServerName db.adebisi.ro
              Redirect permanent / https://db.adebisi.ro/
          </VirtualHost>

          <VirtualHost *:443>
              ServerName db.adebisi.ro
              DocumentRoot /var/www/adminer

              SSLEngine on
              SSLCertificateFile /etc/letsencrypt/live/db.adebisi.ro/fullchain.pem
              SSLCertificateKeyFile /etc/letsencrypt/live/db.adebisi.ro/privkey.pem

              <Directory /var/www/adminer>
                  DirectoryIndex index.php
                  AllowOverride None
                  Require all granted
              </Directory>

              <FilesMatch "\.php$">
                  SetHandler "proxy:unix:$PHP_FPM_SOCK|fcgi://localhost/"
              </FilesMatch>
          </VirtualHost>
          APACHE
            else
              cat >/etc/apache2/sites-available/db.adebisi.ro.conf <<APACHE
          <VirtualHost *:80>
              ServerName db.adebisi.ro
              DocumentRoot /var/www/adminer

              <Directory /var/www/adminer>
                  DirectoryIndex index.php
                  AllowOverride None
                  Require all granted
              </Directory>

              <FilesMatch "\.php$">
                  SetHandler "proxy:unix:$PHP_FPM_SOCK|fcgi://localhost/"
              </FilesMatch>
          </VirtualHost>
          APACHE
            fi

            a2dissite db.adebisi.ro-le-ssl.conf >/dev/null 2>&1 || true
            a2ensite db.adebisi.ro.conf >/dev/null
            apache2ctl configtest
            systemctl restart "$PHP_FPM_SERVICE"
            if ! systemctl reload apache2; then
              systemctl restart apache2
            fi
            systemctl status apache2 --no-pager -l || true
            ss -ltnp | grep -E ':(80|443)\s' || true
          else
            ln -sf /etc/nginx/sites-available/db.adebisi.ro /etc/nginx/sites-enabled/db.adebisi.ro
            nginx -t
            systemctl restart "$PHP_FPM_SERVICE"
            if ! systemctl reload nginx; then
              echo "Nginx reload failed, trying full restart..."
              if ! systemctl restart nginx; then
                echo "Nginx failed to start. Diagnostics:"
                systemctl status nginx --no-pager -l || true
                journalctl -xeu nginx.service --no-pager | tail -n 120 || true
                ss -ltnp | grep -E ':(80|443)\s' || true
                exit 1
              fi
            fi
          fi

          cd /var/www/datesantiere
          git pull
          dotnet publish -c Release -o /var/www/datesantiere/publish

          mkdir -p /etc/systemd/system/datesantiere.service.d
          mkdir -p /etc/datesantiere
          APP_CONN_ESC="$(printf '%s' "$APP_CONN" | sed 's/\\/\\\\/g; s/\"/\\\"/g')"
          printf '%s\n' "ConnectionStrings__DefaultConnection=\"$APP_CONN_ESC\"" >/etc/datesantiere/datesantiere.env
          chmod 600 /etc/datesantiere/datesantiere.env

          cat >/etc/systemd/system/datesantiere.service.d/override.conf <<SYSTEMD
          [Service]
          EnvironmentFile=/etc/datesantiere/datesantiere.env
          SYSTEMD
          chmod 600 /etc/systemd/system/datesantiere.service.d/override.conf
          systemctl daemon-reload

          cd /var/www/datesantiere/DateSantiere.Web
          ConnectionStrings__DefaultConnection="$APP_CONN" dotnet ef database update
          systemctl restart datesantiere
          echo "MySQL configured for app: host=127.0.0.1 db=$APP_DB_NAME user=$APP_DB_USER"
          EOF
