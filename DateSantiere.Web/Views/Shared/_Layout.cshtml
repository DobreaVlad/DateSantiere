@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@inject UserManager<DateSantiere.Models.ApplicationUser> UserManager

<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - DateSantiere</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/site-beta.css" asp-append-version="true" />
    <style>
        /* Modern Modal Styles */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 60px;
        }
        
        .modal-header .modal-title {
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
            flex: 1;
            text-align: center;
            line-height: 1;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
            margin: 0;
            padding: 0;
        }
        
        .modal-header .btn-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: 2rem;
            background: #f8f9fa;
        }
        
        .modal-body .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .modal-body .form-control {
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .modal-body .form-control:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
            background: white;
        }
        
        .modal-body .form-check-input {
            border-radius: 4px;
            border: 2px solid #dee2e6;
            width: 1.2rem;
            height: 1.2rem;
        }
        
        .modal-body .form-check-input:checked {
            background-color: #f97316;
            border-color: #f97316;
        }
        
        .modal-body .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }
        
        .modal-body .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .modal-body .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .modal-body .btn-primary:active {
            transform: translateY(0);
        }
        
        .modal-body a {
            color: #f97316;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .modal-body a:hover {
            color: #ea580c;
            text-decoration: underline;
        }
        
        .modal-body .text-muted {
            color: #6c757d !important;
            font-size: 0.9rem;
        }
        
        /* Modal animation */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: scale(0.8);
        }
        
        .modal.show .modal-dialog {
            transform: scale(1);
        }
        
        /* Divider */
        .modal-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1.5rem 0;
        }
        
        .modal-divider::before,
        .modal-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-divider span {
            padding: 0 1rem;
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .transparent-header {
            /* Match the default site header background so it is not transparent */
            background: linear-gradient(to bottom, #2d2d2d 0%, #414141 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .transparent-header .header-nav a,
        .transparent-header .account-toggle {
            color: #000000 !important;
        }
        
        .transparent-header .header-nav a:hover {
            color: #333333 !important;
        }
        
        .transparent-header .account-toggle:hover {
            color: #333333 !important;
        }
    </style>
</head>
<body>
    @{
        var headerClass = ViewData["IsHome"] != null ? "site-header transparent-header" : "site-header";
    }
    <header class="@headerClass">
        <div class="nav-bar">
            <div class="container nav-inner">
                <a class="brand" asp-controller="Home" asp-action="Index" style="display: flex; align-items: flex-end; line-height: 1; margin-bottom: 12px;">
                    <img src="https://beta-production-bd28.up.railway.app/public/logo.png" alt="DateSantiere Logo" style="height: 32px; margin-right: 8px; display: block;">
                    <span style="line-height: 1;">DateSantiere</span>
                </a>
                <nav class="header-nav">
                    <a asp-controller="Santiere" asp-action="Index">Santiere</a>
                    <a asp-controller="Home" asp-action="Pricing">Prețuri</a>
                    <a asp-controller="Home" asp-action="About">Despre Noi</a>
                    <a asp-controller="Home" asp-action="Contact">Contact</a>
                </nav>
                <div class="auth-actions">
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="account-dropdown-wrapper">
                            <button class="account-toggle" id="accountToggle" title="Setări cont">
                                @{
                                    var currentUser = await UserManager.GetUserAsync(User);
                                    var displayName = "User";
                                    
                                    if (currentUser != null)
                                    {
                                        if (!string.IsNullOrEmpty(currentUser.FirstName) && !string.IsNullOrEmpty(currentUser.LastName))
                                        {
                                            displayName = $"{currentUser.FirstName} {currentUser.LastName}";
                                        }
                                        else if (!string.IsNullOrEmpty(currentUser.FirstName))
                                        {
                                            displayName = currentUser.FirstName;
                                        }
                                        else if (!string.IsNullOrEmpty(currentUser.LastName))
                                        {
                                            displayName = currentUser.LastName;
                                        }
                                        else
                                        {
                                            displayName = currentUser.Email?.Split('@')[0] ?? "User";
                                        }
                                    }
                                }
                                Buna, @displayName
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <div class="account-dropdown-menu" id="accountDropdownMenu">
                                <a href="@Url.Action("Profile", "Account")" class="account-dropdown-item">
                                    <i class="bi bi-person"></i>
                                    <span>Profil</span>
                                </a>
                                <form method="post" asp-controller="Account" asp-action="Logout" style="margin: 0; display: contents;">
                                    <button type="submit" class="account-dropdown-item account-dropdown-logout">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span>Ieșire</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <a href="@Url.Action("Index", "Admin")" class="admin-settings-icon" title="Panou Admin">
                            <i class="bi bi-gear-fill"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Autentificare</button>
                        <button class="btn-secondary" data-bs-toggle="modal" data-bs-target="#registerModal">Înregistrare</button>
                    }
                </div>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="loginModalLabel">Autentificare</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-controller="Account" asp-action="Login" id="loginForm">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="loginEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Parolă</label>
                            <input type="password" class="form-control" id="loginPassword" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe" value="true">
                            <label class="form-check-label" for="rememberMe">Ține-mă minte</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Autentificare</button>
                        <div class="text-center mt-3">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal" data-bs-dismiss="modal">Ai uitat parola?</a>
                        </div>
                        <div class="text-center mt-2">
                            <span>Nu ai cont? </span>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">Înregistrează-te</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="registerModalLabel">Înregistrare</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-controller="Account" asp-action="Register" id="registerForm">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="registerFirstName" class="form-label">Prenume</label>
                            <input type="text" class="form-control" id="registerFirstName" name="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerLastName" class="form-label">Nume</label>
                            <input type="text" class="form-control" id="registerLastName" name="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="registerEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Parolă</label>
                            <input type="password" class="form-control" id="registerPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerConfirmPassword" class="form-label">Confirmă Parola</label>
                            <input type="password" class="form-control" id="registerConfirmPassword" name="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Înregistrare</button>
                        <div class="text-center mt-3">
                            <span>Ai deja cont? </span>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Autentifică-te</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="forgotPasswordModalLabel">Resetare Parolă</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-controller="Account" asp-action="ForgotPassword" id="forgotPasswordForm">
                        @Html.AntiForgeryToken()
                        <p class="text-muted">Introdu adresa de email și îți vom trimite un link pentru resetarea parolei.</p>
                        <div class="mb-3">
                            <label for="forgotEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="forgotEmail" name="email" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Trimite Link</button>
                        <div class="text-center mt-3">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Înapoi la autentificare</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <main role="main">
        @RenderBody()
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>DateSantiere</h3>
                    <p>Platforma numărul 1 pentru căutarea șantierelor din România</p>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <ul>
                        <li><p>Str. Croitorilor, nr 24, Cluj-Napoca</p></li>
                        <li><p>0766.183.434</p></li>
                        <li><p>office@datesantiere.ro</p></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Pagini Utile</h3>
                    <ul>
                        <li><a href="#">Termeni și Condiții</a></li>
                        <li><a href="#">Politica de Confidențialitate</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a asp-controller="Home" asp-action="Privacy">Privacy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 - DateSantiere - Callinvest SRL. Toate drepturile rezervate.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script>
        // Handle login form submit
        document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = result.redirectUrl;
                } else {
                    alert(result.error || 'Eroare la autentificare');
                }
            } catch (error) {
                alert('Eroare de conexiune');
            }
        });
        
        // Handle register form submit
        document.getElementById('registerForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = result.redirectUrl;
                } else {
                    alert(result.error || 'Eroare la înregistrare');
                }
            } catch (error) {
                alert('Eroare de conexiune');
            }
        });
        
        // Handle forgot password form submit
        document.getElementById('forgotPasswordForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Link de resetare trimis pe email!');
                    bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal')).hide();
                } else {
                    alert(result.error || 'Eroare la trimiterea email-ului');
                }
            } catch (error) {
                alert('Eroare de conexiune');
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
