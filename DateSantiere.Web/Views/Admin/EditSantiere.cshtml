@model Santier

@{
    ViewData["Title"] = "Editare Șantier";
    var isNew = Model.Id == 0;
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
    #map {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #d1d5db;
    }
    
    .leaflet-container {
        font-family: inherit;
    }
    
    .geocoder-results {
        position: absolute;
        top: 45px;
        left: 10px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        min-width: 250px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .geocoder-result {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
    }
    
    .geocoder-result:last-child {
        border-bottom: none;
    }
    
    .geocoder-result:hover {
        background: #f3f4f6;
    }
</style>

<div style="padding: 40px 0; background: #e5e7eb; min-height: calc(100vh - 200px);">
    <div class="container" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="color: #374151; margin: 0;">@(isNew ? "Adaugă Șantier" : "Editare Șantier")</h1>
            <a asp-action="Santiere" class="btn" style="background: #6b7280; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">
                <i class="bi bi-arrow-left"></i> Înapoi
            </a>
        </div>

        <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <form method="post" asp-action="@(isNew ? "CreateSantiere" : "EditSantiere")">
                @if (!isNew)
                {
                    <input type="hidden" asp-for="Id" />
                }

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Name" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Nume Șantier *</label>
                        <input asp-for="Name" type="text" placeholder="Introduceți numele șantierului"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <span asp-validation-for="Name" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;"></span>
                    </div>

                    <div>
                        <label asp-for="Judet" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Județ *</label>
                        <input asp-for="Judet" type="text" placeholder="Introduceți județul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <span asp-validation-for="Judet" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;"></span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Localitate" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Localitate *</label>
                        <input asp-for="Localitate" type="text" placeholder="Introduceți localitatea"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <span asp-validation-for="Localitate" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;"></span>
                    </div>

                    <div>
                        <label asp-for="Adresa" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Adresă</label>
                        <input asp-for="Adresa" type="text" placeholder="Introduceți adresa"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Categorie" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Categorie *</label>
                        <input asp-for="Categorie" type="text" placeholder="Introduceți categoria"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <span asp-validation-for="Categorie" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;"></span>
                    </div>

                    <div>
                        <label asp-for="Subcategorie" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Subcategorie</label>
                        <input asp-for="Subcategorie" type="text" placeholder="Introduceți subcategoria"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Beneficiar" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Beneficiar *</label>
                        <input asp-for="Beneficiar" type="text" placeholder="Introduceți beneficiarul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <span asp-validation-for="Beneficiar" style="color: #ef4444; font-size: 12px; margin-top: 4px; display: block;"></span>
                    </div>

                    <div>
                        <label asp-for="BeneficiarCUI" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">CUI Beneficiar</label>
                        <input asp-for="BeneficiarCUI" type="text" placeholder="Introduceți CUI-ul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label asp-for="Description" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Descriere</label>
                    <textarea asp-for="Description" placeholder="Introduceți descrierea"
                              style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; min-height: 100px;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Status" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Status</label>
                        <input asp-for="Status" type="text" placeholder="De ex: În curs, Completat"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label asp-for="ValoareEstimata" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Valoare Estimată</label>
                        <input asp-for="ValoareEstimata" type="number" placeholder="0" step="0.01"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label asp-for="IsFeatured" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Evidențiat</label>
                        <input asp-for="IsFeatured" type="checkbox" style="width: 18px; height: 18px; cursor: pointer; margin-top: 8px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="DataIncepere" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Data Inceput</label>
                        <input asp-for="DataIncepere" type="date"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label asp-for="DataFinalizare" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Data Finalizare</label>
                        <input asp-for="DataFinalizare" type="date"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="ContactPersoana" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Contact - Persoană</label>
                        <input asp-for="ContactPersoana" type="text" placeholder="Introduceți persoana de contact"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label asp-for="ContactTelefon" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Contact - Telefon</label>
                        <input asp-for="ContactTelefon" type="tel" placeholder="Introduceți numărul de telefon"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="ContactEmail" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Contact - Email</label>
                        <input asp-for="ContactEmail" type="email" placeholder="Introduceți emailul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Status Activ</label>
                        <input asp-for="IsActive" type="checkbox" checked="@Model.IsActive" style="width: 18px; height: 18px; cursor: pointer; margin-top: 8px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label asp-for="Proiectant" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Proiectant</label>
                        <input asp-for="Proiectant" type="text" placeholder="Introduceți proiectantul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>

                    <div>
                        <label asp-for="Constructor" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Constructor</label>
                        <input asp-for="Constructor" type="text" placeholder="Introduceți constructorul"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <!-- Location Section with Map -->
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #374151; font-weight: 600; margin-bottom: 15px; margin-top: 30px;">Locație</h3>
                    
                    <!-- Search Input -->
                    <div style="position: relative; margin-bottom: 15px;">
                        <label style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Căutare Locație</label>
                        <input id="locationSearch" type="text" placeholder="Căutați adresa, sat, oras..."
                               style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <div id="geocoder-results" class="geocoder-results" style="display: none;"></div>
                    </div>

                    <!-- Map -->
                    <div id="map"></div>

                    <!-- Coordinates Display -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label asp-for="Latitude" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Latitudine</label>
                            <input asp-for="Latitude" type="number" placeholder="0" step="0.000001" id="latitudeInput"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            <small style="color: #6b7280;">Faceți clic pe hartă sau selectați din rezultate</small>
                        </div>

                        <div>
                            <label asp-for="Longitude" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Longitudine</label>
                            <input asp-for="Longitude" type="number" placeholder="0" step="0.000001" id="longitudeInput"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            <small style="color: #6b7280;">Faceți clic pe hartă sau selectați din rezultate</small>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label asp-for="Observatii" style="display: block; color: #374151; font-weight: 600; margin-bottom: 8px;">Observații</label>
                    <textarea asp-for="Observatii" placeholder="Introduceți observațiile"
                              style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; min-height: 100px;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <a asp-action="Santiere" class="btn" style="padding: 10px 20px; background: #6b7280; color: white; border-radius: 8px; text-decoration: none; cursor: pointer;">
                        Anulare
                    </a>
                    <button type="submit" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="bi bi-check-circle"></i> @(isNew ? "Creare" : "Salvare")
                    </button>
                </div>
            </form>
        </div>

        @if (!ViewData.ModelState.IsValid)
        {
            <div style="background: white; border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ef4444;">
                <h3 style="color: #991b1b; margin-top: 0;">Erori de validare:</h3>
                <ul style="color: #991b1b; margin-bottom: 0;">
                    @foreach (var modelState in ViewData.ModelState.Values)
                    {
                        @foreach (var error in modelState.Errors)
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    }
                </ul>
            </div>
        }
    </div>
</div>

<script>
// Initialize map
let map;
let marker;
let debounceTimer;

function initMap() {
    const lat = parseFloat(document.getElementById('latitudeInput').value) || 45.943161;
    const lng = parseFloat(document.getElementById('longitudeInput').value) || 24.966760;
    
    map = L.map('map').setView([lat, lng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Add marker if coordinates exist
    if (lat && lng) {
        addMarker(lat, lng);
    }
    
    // Click to set location
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        updateCoordinates(lat, lng);
    });
}

function addMarker(lat, lng) {
    if (marker) {
        map.removeLayer(marker);
    }
    marker = L.marker([lat, lng]).addTo(map);
    map.setView([lat, lng], 13);
}

function updateCoordinates(lat, lng) {
    document.getElementById('latitudeInput').value = lat.toFixed(6);
    document.getElementById('longitudeInput').value = lng.toFixed(6);
    addMarker(lat, lng);
}

// Geocoding with Nominatim
const searchInput = document.getElementById('locationSearch');
const resultsDiv = document.getElementById('geocoder-results');

searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    if (query.length < 3) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    debounceTimer = setTimeout(() => {
        geocodeSearch(query);
    }, 300);
});

async function geocodeSearch(query) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=ro`
        );
        const results = await response.json();
        
        if (results.length > 0) {
            displayResults(results);
        } else {
            resultsDiv.innerHTML = '<div class="geocoder-result" style="padding: 15px; text-align: center; color: #6b7280;">Nu au fost găsite rezultate</div>';
            resultsDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Geocoding error:', error);
        resultsDiv.innerHTML = '<div class="geocoder-result" style="padding: 15px; color: #ef4444;">Eroare la căutare</div>';
        resultsDiv.style.display = 'block';
    }
}

function displayResults(results) {
    resultsDiv.innerHTML = '';
    results.forEach(result => {
        const div = document.createElement('div');
        div.className = 'geocoder-result';
        div.innerHTML = `
            <strong>${result.name || result.display_name}</strong><br>
            <small style="color: #6b7280;">${result.display_name}</small>
        `;
        div.onclick = () => selectLocation(result);
        resultsDiv.appendChild(div);
    });
    resultsDiv.style.display = 'block';
}

function selectLocation(result) {
    const lat = parseFloat(result.lat);
    const lng = parseFloat(result.lon);
    updateCoordinates(lat, lng);
    document.getElementById('locationSearch').value = result.display_name;
    resultsDiv.style.display = 'none';
}

// Close results when clicking outside
document.addEventListener('click', function(event) {
    if (event.target !== searchInput && event.target !== resultsDiv) {
        resultsDiv.style.display = 'none';
    }
});

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', initMap);

// Update map if coordinates change manually
document.getElementById('latitudeInput').addEventListener('change', function() {
    const lat = parseFloat(this.value);
    const lng = parseFloat(document.getElementById('longitudeInput').value);
    if (lat && lng) {
        addMarker(lat, lng);
    }
});

document.getElementById('longitudeInput').addEventListener('change', function() {
    const lat = parseFloat(document.getElementById('latitudeInput').value);
    const lng = parseFloat(this.value);
    if (lat && lng) {
        addMarker(lat, lng);
    }
});
</script>
